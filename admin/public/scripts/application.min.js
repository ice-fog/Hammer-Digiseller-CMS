function init(){$('[data-toggle="tooltip"]').tooltip(),$(".selectpicker").selectpicker(),$("#selectAll").click(function(){$("input:checkbox").not(this).prop("checked",this.checked)}),$("#search-form").bootstrapValidator({fields:{search:{validators:{notEmpty:{message:"Запрос не может быть пустым."}}}}}),$("ul.nav a").filter(function(){return this.href==window.location}).parent().addClass("active"),pagesActionHandler(),sysPagesActionHandler(),deliveryActionHandler(),feedbackActionHandler(),editorActionHandler(),settingsActionHandler(),statisticsInit(),serviceInit()}function updateOuter(){$("#content-outer").load(document.location.href+" #content-row",function(){init()})}function deliveryActionHandler(){if(!(document.location.href.indexOf("delivery")<0)){var e=$(".new-delivery");$("table tr").length<1&&e.addClass("disabled").removeClass("new-delivery"),e.on("click",function(){newDelivery()}),$(".btn-email-checkbox").on("click",function(){emailCheckboxHandler()}),$(".email-action div").on("click",function(){var e=$(this).closest("tr.email-list").attr("id").split("-")[1],t=$(this).attr("class");switch(t){case"email-update-status-on":emailUpdateStatus(e,0);break;case"email-update-status-off":emailUpdateStatus(e,1);break;case"email-delete":emailDelete(e)}})}}function newDelivery(){$.post("/admin/delivery/ajax",{action:"get-form-new"},function(e){bootbox.dialog({title:"Новая рассылка",message:e,className:"big-modal",buttons:{success:{label:"Разослать",className:"btn-success",callback:function(){var e=$("#delivery-form-new").serialize();return $("#name").val().length>0&&$("#content").val().length>0?void $.post("/admin/delivery/ajax",e,function(e){"ok"==e?$.notify("Рассылка завершена!","success"):$.notify("Возникла ошибка!","error")}):($("#delivery-form-new").submit(),!1)}},danger:{label:"Отмена",className:"btn-danger",callback:function(){}}}}),$("#content").trumbowyg({btnsDef:{image:{dropdown:["insertImage","upload","base64"],ico:"insertImage"}},btns:["viewHTML","|","formatting","|","btnGrp-design","|","link","|","image","|","btnGrp-justify","|","btnGrp-lists","|","foreColor","backColor","|","horizontalRule"]}),$("#delivery-form-new").bootstrapValidator({fields:{name:{validators:{notEmpty:{message:"Не может быть пустым."}}},content:{validators:{notEmpty:{message:"Не может быть пустым."}}}}})})}function emailUpdateStatus(e,t){var a="";a=1==t?"Сделать e-mail активным?":"Сделать e-mail неактивным?",bootbox.dialog({message:a,buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/delivery/ajax",{action:"update-status",status:t,id:e},function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function emailCheckboxHandler(){bootbox.dialog({message:"Выполнить выбранное действие?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/delivery/ajax",$("#list-email-form").serialize(),function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function emailDelete(e){bootbox.dialog({message:"Удалить e-mail из списка рассылки?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/delivery/ajax",{action:"delete",id:e},function(e){"ok"==e?$.notify("E-mail удален!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function sysPagesActionHandler(){document.location.href.indexOf("pages/system")<0||$(".sys-pages-action div").on("click",function(){var e=$(this).closest("tr.sys-pages-list").attr("id").split("sys-page-")[1],t=$(this).attr("class");switch(t){case"sys-page-edit":sysPageEdit(e)}})}function sysPageEditorInit(){$("#content").trumbowyg({btnsDef:{image:{dropdown:["insertImage","upload","base64"],ico:"insertImage"}},btns:["viewHTML","|","formatting","|","btnGrp-design","|","link","|","image","|","btnGrp-justify","|","btnGrp-lists","|","foreColor","backColor","|","horizontalRule"]})}function sysPageEdit(e){function t(e){bootbox.dialog({title:a,message:e,className:"big-modal",buttons:{success:{label:"Сохранить",className:"btn-success",callback:function(){return $("#content").val().length>0?void $.post("/admin/pages/ajax",$("#sys-page-form-edit").serialize(),function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error")}):($("#sys-page-form-edit").submit(),!1)}},danger:{label:"Отмена",className:"btn-danger",callback:function(){}}}}),sysPageEditorInit(),$(".selectpicker").selectpicker(),$("#sys-page-form-edit").bootstrapValidator({fields:{content:{validators:{notEmpty:{message:"Не может быть пустым."}}}}})}var a="";"home"==e?a="Редактирование главной страницы":"not-found"==e&&(a="Редактирование страницы 404"),$.post("/admin/pages/ajax",{action:"get-form-sys-edit",page:e},t)}function pagesActionHandler(){document.location.href.indexOf("pages")<0||($(".page-add").on("click",function(){pageAdd()}),$(".bnt-pages-checkbox").on("click",function(){pagesCheckboxHandler()}),$(".pages-action div").on("click",function(){var e=$(this).closest("tr.pages-list").attr("id").split("-")[1],t=$(this).attr("class");switch(t){case"page-edit":pageEdit(e);break;case"page-update-status-on":pageUpdateStatus(e,0);break;case"page-update-status-off":pageUpdateStatus(e,1);break;case"page-delete":pageDelete(e)}}))}function pageModalHelper(){var e=!1;return $("#title").val().length<1||$("#url").val().length<1||$("#description").val().length<1?($("#nav-options").css({color:"#A94442"}),e=!0):$("#nav-options").css({color:"#3C763D"}),$("#content").val().length<1?($("#nav-content").css({color:"#A94442"}),e=!0):$("#nav-content").css({color:"#3C763D"}),e}function pageEditorInit(){$("#content").trumbowyg({btnsDef:{image:{dropdown:["insertImage","upload","base64"],ico:"insertImage"}},btns:["viewHTML","|","formatting","|","btnGrp-design","|","link","|","image","|","btnGrp-justify","|","btnGrp-lists","|","foreColor","backColor","|","horizontalRule"]}).on("tbwchange",function(){pageModalHelper()})}function pageCheckFreeURL(e,t){var a=!1;return $.ajax({async:!1,type:"POST",url:"/admin/pages/ajax",data:"action=check-free-url&url="+e,success:function(e){a="ok"==e?!0:e==t?!0:!1}}),a}function pageAdd(){function e(e){bootbox.dialog({title:"Новая страница",message:e,className:"big-modal",buttons:{success:{label:"Сохранить",className:"btn-success",callback:function(){return pageCheckFreeURL($("#url").val())?pageModalHelper()?($("#page-form-add").submit(),!1):void $.post("/admin/pages/ajax",$("#page-form-add").serialize(),function(e){"ok"==e?$.notify("Страница добавлена!","success"):$.notify("Возникла ошибка!","error"),updateOuter()}):($.notify("Этот адрес уже используется","error"),$("#url").closest(".form-group").addClass("has-error"),!1)}},danger:{label:"Отмена",className:"btn-danger",callback:function(){}}}}),$(".form-control").on("change paste keyup",function(){pageModalHelper()}),pageEditorInit(),$(".selectpicker").selectpicker(),$("#title").on("input",function(){$("#title").liTranslit({elAlias:$("#url")})}),$("#page-form-add").bootstrapValidator({fields:{title:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:255,message:"Не более 255 символов"}}},url:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:255,message:"Не более 255 символов"}}},description:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:200,message:"Не более 200 символов"}}},content:{validators:{notEmpty:{message:"Не может быть пустым."}}}}})}$.post("/admin/pages/ajax",{action:"get-form-add"},e)}function pageEdit(e){function t(e){bootbox.dialog({title:"Редактирования страницы",message:e,className:"big-modal",buttons:{success:{label:"Сохранить",className:"btn-success",callback:function(){return pageCheckFreeURL($("#url").val(),$("#id").val())?pageModalHelper()?($("#page-form-add").submit(),!1):void $.post("/admin/pages/ajax",$("#page-form-edit").serialize(),function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),updateOuter()}):($.notify("Этот адрес уже используется!","error"),$("#url").closest(".form-group").addClass("has-error"),!1)}},danger:{label:"Отмена",className:"btn-danger",callback:function(){}}}}),$(".form-control").on("change paste keyup",function(){pageModalHelper()}),pageEditorInit(),$(".selectpicker").selectpicker(),$("#title").on("input",function(){$("#title").liTranslit({elAlias:$("#url")})}),$("#page-form-edit").bootstrapValidator({fields:{title:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:255,message:"Не более 255 символов"}}},url:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:255,message:"Не более 255 символов"}}},description:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:200,message:"Не более 200 символов"}}},content:{validators:{notEmpty:{message:"Не может быть пустым."}}}}})}$.post("/admin/pages/ajax",{action:"get-form-edit",id:e},t)}function pageUpdateStatus(e,t){var a="";a=1==t?"Сделать активной эту страницу?":"Сделать неактивной эту страницу?",bootbox.dialog({message:a,buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/pages/ajax",{action:"update-status",status:t,id:e},function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function pagesCheckboxHandler(){var e=$("#list-pages-form").serialize();e.indexOf("id")+1?bootbox.dialog({message:"Выполнить выбраннае действия?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/pages/ajax",e,function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}}):bootbox.alert("Вы ничего не выбрали!")}function pageDelete(e){bootbox.dialog({message:"Удалить эту страницу?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/pages/ajax",{action:"delete",id:e},function(e){"ok"==e?$.notify("Страница удалена!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function feedbackActionHandler(){document.location.href.indexOf("feedback")<0||($(".btn-feedback-checkbox").on("click",function(){feedbackCheckboxHandler()}),$(".feedback-action div").on("click",function(){var e=$(this).closest("tr.feedback-list").attr("id").split("-")[1],t=$(this).attr("class");switch(t){case"feedback-archive":feedbackArchive(e);break;case"feedback-delete":feedbackDelete(e)}}))}function feedbackArchive(e){bootbox.dialog({message:"Переместить сообщение в архив?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/feedback/ajax",{action:"archive",id:e},function(e){"ok"==e?$.notify("Сообщение перемещено в архив!","success"):$.notify("Возникла ошибка при архивации!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function feedbackCheckboxHandler(){var e=$("#list-feedback-form").serialize();e.indexOf("id")+1?bootbox.dialog({message:"Выполнить выбраннае действия?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/feedback/ajax",e,function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}}):bootbox.alert("Вы ничего не выбрали!")}function feedbackDelete(e){bootbox.dialog({message:"Удалить это сообщение?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/feedback/ajax",{action:"delete",id:e},function(e){"ok"==e?$.notify("Сообщение удалено!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}function getFileContent(e){var t="";return $.ajax({type:"POST",async:!1,data:"file="+e,url:"/admin/editor/load",success:function(e){t=e}}),t}function editorActionHandler(){if(!(document.location.href.indexOf("editor")<0)){var e="../public/main.tpl",t=$("#editor-file-list"),a=$(".btn-editor-save"),s=$(".editor-info"),o=CodeMirror.fromTextArea(document.getElementById("editor-area"),{lineNumbers:!0,matchBrackets:!0,mode:"htmlmixed",indentUnit:4});o.getDoc().setValue(getFileContent(e)),s.text("Сейчас редактируется: "+e.replace("..","")),t.fileTree({root:"../public/",script:"/admin/editor/get",folderEvent:"click",multiFolder:!1},function(t){e=t,o.setOption("mode",editorCheckMode(e)),o.getDoc().setValue(getFileContent(e)),s.text("Сейчас редактируется: "+e.replace("..",""))}),a.on("click",function(){$.post("/admin/editor/save",{file:e,content:o.getDoc().getValue()},function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error")})})}}function editorCheckMode(e){var t=e.split("."),a="";switch(t[t.length-1]){case"tpl":a="htmlmixed";break;case"css":a="css";break;case"js":a="javascript"}return a}function statisticsInit(){document.location.href.indexOf("statistics")<0||($(".view-log").on("click",function(){$.post("/admin/statistics/ajax",{action:"get-log"},function(e){bootbox.dialog({title:"Последние 1000 запросов",message:'<textarea class="form-control" rows="30" style="font-size: 10px;">'+e+"</textarea>",className:"big-modal",buttons:{success:{label:"Ok",className:"btn-success",callback:function(){}}}})})}),$.post("/admin/statistics/ajax",{action:"get-stat"},function(e){var t=[],a=[],s=[];e=JSON.parse(e),$.each(e,function(e,o){t.push(o.period),a.push(o.uniques),s.push(o.total)});var o={labels:t,datasets:[{fillColor:"rgba(220,220,220,0.2)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:s},{fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:a}]},n=document.getElementById("statistics-chart-canvas").getContext("2d");window.myBar=new Chart(n).Line(o,{responsive:!0})}))}function serviceInit(){document.location.href.indexOf("service")<0||($.post("/admin/service/ajax",{action:"get-cache-size"},function(e){e=JSON.parse(e),$(".section-cache-size").text("Списки разделов: "+e.section),$(".goods-cache-size").text("Списки товаров в разделах: "+e.goods),$(".seller-cache-size").text("Списки товаров продавцов: "+e.seller),$(".total-cache-size").text("Всего занято кэшем: "+e.total);var t=parseFloat(e.section.split(" ")[0].replace(/[,]+/g,".")),a=parseFloat(e.goods.split(" ")[0].replace(/[,]+/g,".")),s=parseFloat(e.seller.split(" ")[0].replace(/[,]+/g,".")),o=[{value:"MB"==e.section.split(" ")[1]?1024*t:t,color:"#5B90BF",highlight:"#66B2E4",label:"Списки разделов"},{value:"MB"==e.goods.split(" ")[1]?1024*a:a,color:"#96b5b4",highlight:"#B3D5D4",label:"Списки товаров в разделах"},{value:"MB"==e.seller.split(" ")[1]?1024*s:s,color:"#a3be8c",highlight:"#BFDDA2",label:"Списки товаров продавцов"}],n=document.getElementById("cache-chart-canvas").getContext("2d");window.myBar=new Chart(n).Pie(o,{tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value %> KB",responsive:!0})}),$(".all-cache-clear").click(function(){bootbox.dialog({message:"Очистить весь кэш?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/service/ajax",{action:"cache-clear",type:3},function(e){"ok"==e?$.notify("Очистка кэша завершена!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}),$(".section-cache-clear").click(function(){bootbox.dialog({message:"Очистить кэш разделов?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/service/ajax",{action:"cache-clear",type:0},function(e){"ok"==e?$.notify("Очистка кэша завершена!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}),$(".goods-cache-clear").click(function(){bootbox.dialog({message:"Очистить кэш товаров?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/service/ajax",{action:"cache-clear",type:1},function(e){"ok"==e?$.notify("Очистка кэша завершена!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}),$(".seller-cache-clear").click(function(){bootbox.dialog({message:"Очистить кэш продавцов?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/service/ajax",{action:"cache-clear",type:2},function(e){"ok"==e?$.notify("Очистка кэша завершена!","success"):$.notify("Возникла ошибка!","error"),updateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}))}function settingsActionHandler(){document.location.href.indexOf("settings")<0||($(":checkbox").checkboxpicker(),$(".profile-edit").on("click",function(){$.post("/admin/users/ajax",{action:"get-form-edit",id:1},function(e){bootbox.dialog({title:"Редактирование данных пользователя",message:e,buttons:{success:{label:"Сохранить",className:"btn-success",callback:function(){return $("#user-form-edit").submit(),!1}},danger:{label:"Отмена",className:"btn-danger",callback:function(){}}}}),$("#user-form-edit").bootstrapValidator({fields:{login:{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:32,message:"Не более 32 символов"}}},"old-password":{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:32,message:"Не более 32 символов"}}}}}).on("success.form.bv",function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,$.post("/admin/users/ajax",$(e.target).serialize()+"&action=edit&id=1",function(e){"ok"==e?($.notify("Изменения сохранены!","success"),bootbox.hideAll()):"wrong-password"==e?($("#old-password").val(""),$("#old-password").closest(".form-group").addClass("has-error"),$.notify("Текущий пароль введен неверно!","error")):$.notify("Возникла ошибка!","error")})})})}),$("#settings-form").bootstrapValidator({fields:{"site-title":{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:255,message:"Не более 255 символов"}}},"site-description":{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{max:160,message:"Не более 160 символов"}}},"agent-id":{validators:{notEmpty:{message:"Не может быть пустым."},regexp:{regexp:/^\d+$/,message:"Только целое число"}}},"xml-id":{validators:{notEmpty:{message:"Не может быть пустым."},stringLength:{min:32,max:32,message:"Должен содержать 32 симвала"}}},email:{validators:{notEmpty:{message:"Не может быть пустым."},emailAddress:{message:"Введите корректный адрес электронной почты."}}},"records-page":{validators:{notEmpty:{message:"Не может быть пустым."},regexp:{regexp:/^\d+$/,message:"Только целое число"}}},"home-seller":{validators:{notEmpty:{message:"Не может быть пустым."},regexp:{regexp:/^\d+$/,message:"Только целое число"}}},"ad-block-seller":{validators:{notEmpty:{message:"Не может быть пустым."},regexp:{regexp:/^\d+$/,message:"Только целое число"}}}}}).on("success.form.bv",function(e){e.preventDefault?e.preventDefault():e.returnValue=!1,bootbox.dialog({message:"Сохранить изменения?",buttons:{success:{label:"Да",className:"btn-success",callback:function(){$.post("/admin/settings/ajax",$(e.target).serialize()+"&action=update",function(e){"ok"==e?$.notify("Изменения сохранены!","success"):$.notify("Возникла ошибка!","error"),settingsUpdateOuter()})}},danger:{label:"Нет",className:"btn-danger",callback:function(){}}}})}))}function settingsUpdateOuter(){$("#content-outer").load(document.location.href+" #content-outer",function(){init(),$(":checkbox").checkboxpicker()})}